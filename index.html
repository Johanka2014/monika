import React, { useState, useEffect } from 'react';

// Main App Component
export default function App() {
    // --- STATE MANAGEMENT ---
    const [view, setView] = useState('intro');
    const [questions, setQuestions] = useState([]);
    const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
    const [userAnswers, setUserAnswers] = useState({});
    const [score, setScore] = useState(0);
    const [startTime, setStartTime] = useState(null);
    const [endTime, setEndTime] = useState(null);
    const [selectedWord, setSelectedWord] = useState(null);
    const [selectedDef, setSelectedDef] = useState(null);

    // --- VOCABULARY DATA FROM FILE ---
    // This list is curated from the "monika vocab.txt" file provided and expanded to 40 words.
    const vocabularyList = [
        { word: 'Run out of steam', definition: 'To lose impetus or enthusiasm.' },
        { word: 'Resolution', definition: 'A firm decision to do or not to do something.' },
        { word: 'Permission', definition: 'The action of officially allowing someone to do a particular thing.' },
        { word: 'Adopt', definition: 'To choose to take up, follow, or use.' },
        { word: 'Buy-in', definition: 'Agreement on a course of action.' },
        { word: 'Constructive criticism', definition: 'Offering valid opinions about others\' work in a friendly manner.' },
        { word: 'Landfill', definition: 'A place where waste is buried in the ground.' },
        { word: 'Gadget', definition: 'A small, ingenious mechanical or electronic device.' },
        { word: 'Inevitably', definition: 'As is certain to happen; unavoidably.' },
        { word: 'Persistence', definition: 'Continuing a course of action despite difficulty.' },
        { word: 'Obliged', definition: 'To be legally or morally bound to do something.' },
        { word: 'Anxiety', definition: 'A feeling of worry, nervousness, or unease.' },
        { word: 'Improvise', definition: 'To create and perform spontaneously or without preparation.' },
        { word: 'Obsolete', definition: 'No longer produced or used; out of date.' },
        { word: 'Automated', definition: 'Operated by largely automatic equipment.' },
        { word: 'Promoted', definition: 'To raise someone to a higher position or rank.' },
        { word: 'Conspiracy theory', definition: 'A belief that a covert organization is responsible for an event.' },
        { word: 'Cramped', definition: 'Feeling uncomfortably confined by lack of space.' },
        { word: 'Hoard', definition: 'To accumulate and hide or store away valued objects.' },
        { word: 'Addictive', definition: 'Causing or likely to cause dependency.' },
        { word: 'Allies', definition: 'People or groups that cooperate for a common purpose.' },
        { word: 'Digitize', definition: 'To convert pictures, text, or sound into a digital form.' },
        { word: 'Wrestle', definition: 'To struggle with a difficulty or problem.' },
        { word: 'Stride', definition: 'To walk with long, decisive steps.' },
        { word: 'Shuffle', definition: 'To walk by dragging one\'s feet along the ground.' },
        { word: 'Wander', definition: 'To walk or move in a leisurely or aimless way.' },
        { word: 'Heave', definition: 'To lift or haul something heavy with great effort.' },
        { word: 'Leap', definition: 'To jump or spring a long way.' },
        { word: 'Rebound relationship', definition: 'A romantic relationship started shortly after a breakup.' },
        { word: 'Appreciated', definition: 'To be recognized for one\'s full worth.' },
        { word: 'Acknowledged', definition: 'To be accepted or have the truth of admitted.' },
        { word: 'Substitute', definition: 'To act or serve in place of another.' },
        { word: 'Novice', definition: 'A person new to and inexperienced in a situation.' },
        { word: 'Efficiency', definition: 'The quality of working in a well-organized and competent way.' },
        { word: 'Outright lie', definition: 'A completely and openly false statement.' },
        { word: 'Demolish', definition: 'To pull or knock down a building.' },
        { word: 'Fatality', definition: 'A death resulting from an accident or disaster.' },
        { word: 'Intermittent', definition: 'Occurring at irregular intervals; not continuous.' },
        { word: 'Forbid', definition: 'To refuse to allow something.' },
        { word: 'Congestion', definition: 'The state of being blocked or overly full.' }
    ];

    // --- HOOKS ---
    useEffect(() => {
        generateTestQuestions();
    }, []);

    // --- FUNCTIONS ---
    const shuffleArray = (array) => [...array].sort(() => Math.random() - 0.5);

    const generateTestQuestions = () => {
        const shuffledVocab = shuffleArray(vocabularyList);
        
        // 1. Multiple Choice Questions (10 questions)
        const mcq = shuffledVocab.slice(0, 10).map(vocab => {
            const incorrectDefs = vocabularyList.filter(v => v.word !== vocab.word).map(v => v.definition);
            const options = shuffleArray([vocab.definition, ...shuffleArray(incorrectDefs).slice(0, 3)]);
            return {
                type: 'multiple-choice',
                question: `What is the definition of "${vocab.word}"?`,
                word: vocab.word,
                options: options,
                correctAnswer: vocab.definition
            };
        });

        // 2. Fill in the Blank Questions (8 questions from a pool)
        const fillInBlanksData = [
            { question: 'It is very difficult to get ________ when the new software is more complicated.', word: 'Buy-in' },
            { question: 'Admin jobs are becoming ________ because of AI.', word: 'Obsolete' },
            { question: 'The room is now very ________ with the new wardrobe. There is not any space', word: 'Cramped' },
            { question: 'Running can be very ________ if you do it every day.', word: 'Addictive' },
            { question: 'Soldiers ________ with confidence, showing their training.', word: 'Stride' },
            { question: 'She had to ________ with the difficult decision for weeks.', word: 'Wrestle' },
            { question: 'As a ________ in coding, he often asked for help.', word: 'Novice' },
            { question: 'The train service is ________, so you can never be sure when it will arrive.', word: 'Intermittent' },
            { question: 'The old factory is scheduled for the city to ________ it next year.', word: 'Demolish' },
            { question: 'My parents ________ me from going out on school nights.', word: 'Forbid' }
        ];
        const fillInBlanks = shuffleArray(fillInBlanksData).slice(0, 8).map(q => ({ ...q, type: 'fill-in-the-blank', correctAnswer: q.word }));


        // 3. Matching Questions (1 question with 8 pairs)
        const matchingWords = shuffledVocab.slice(10, 18);
        const matchingDefs = shuffleArray(matchingWords.map(v => v.definition));
        const matchingQuestion = {
            type: 'matching',
            question: 'Match the words to their correct definitions.',
            words: matchingWords.map(v => v.word),
            definitions: matchingDefs,
            correctPairs: matchingWords.reduce((acc, v) => ({ ...acc, [v.word]: v.definition }), {})
        };
        
        setQuestions(shuffleArray([...mcq, ...fillInBlanks, matchingQuestion]));
    };

    const startTest = () => {
        generateTestQuestions();
        setView('test');
        setStartTime(Date.now());
        setCurrentQuestionIndex(0);
        setUserAnswers({});
        setScore(0);
        setEndTime(null);
    };

    const handleAnswer = (question, answer) => {
        const key = question.type === 'matching' ? currentQuestionIndex : question.word;
        setUserAnswers(prev => ({ ...prev, [key]: answer }));
    };

    const nextQuestion = () => {
        if (currentQuestionIndex < questions.length - 1) {
            setCurrentQuestionIndex(currentQuestionIndex + 1);
            setSelectedWord(null);
            setSelectedDef(null);
        } else {
            finishTest();
        }
    };
    
    const finishTest = () => {
        let finalScore = 0;
        questions.forEach((q, index) => {
            const key = q.type === 'matching' ? index : q.word;
            const userAnswer = userAnswers[key];
            if (!userAnswer) return;

            if (q.type === 'multiple-choice') {
                if (userAnswer === q.correctAnswer) {
                    finalScore++;
                }
            } else if (q.type === 'fill-in-the-blank') {
                if (userAnswer.trim().toLowerCase() === q.correctAnswer.toLowerCase()) {
                    finalScore++;
                }
            } else if (q.type === 'matching') {
                let correctMatches = 0;
                if(userAnswer) {
                    Object.keys(userAnswer).forEach(word => {
                        if (q.correctPairs[word] === userAnswer[word]) {
                            correctMatches++;
                        }
                    });
                }
                // Award partial points for matching
                finalScore += (correctMatches / q.words.length);
            }
        });
        
        setScore(finalScore);
        setEndTime(Date.now());
        setView('results');
    }

    const handleMatchingClick = (item, type) => {
        const key = currentQuestionIndex;
        let localSelectedWord = selectedWord;
        let localSelectedDef = selectedDef;

        if (type === 'word') {
            setSelectedWord(item);
            localSelectedWord = item;
        } else {
            setSelectedDef(item);
            localSelectedDef = item;
        }

        if (localSelectedWord && localSelectedDef) {
            const currentAnswers = userAnswers[key] || {};
            handleAnswer(questions[currentQuestionIndex], {...currentAnswers, [localSelectedWord]: localSelectedDef });
            setSelectedWord(null);
            setSelectedDef(null);
        }
    };
    
    // --- RENDER FUNCTIONS ---

    const renderIntro = () => (
        <div className="text-center">
            <h1 className="text-4xl font-bold mb-4 text-gray-800">End of Year Vocabulary Test</h1>
            <p className="text-lg text-gray-600 mb-8">This expanded test uses 40 words and includes multiple choice, fill-in-the-blank, and matching questions.</p>
            <button onClick={startTest} className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                Start Test
            </button>
        </div>
    );

    const renderTest = () => {
        const q = questions[currentQuestionIndex];
        if (!q) return <p>Loading questions...</p>;
        
        const progress = ((currentQuestionIndex + 1) / questions.length) * 100;

        return (
            <div>
                 <div className="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                    <div className="bg-blue-500 h-2.5 rounded-full" style={{ width: `${progress}%` }}></div>
                </div>
                <div className="mb-4 text-gray-700">
                    <p className="text-xl font-semibold">Question {currentQuestionIndex + 1} of {questions.length}</p>
                    <p className="text-lg mt-2">{q.question}</p>
                </div>
                
                {q.type === 'multiple-choice' && (
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {q.options.map(option => (
                            <button key={option} onClick={() => handleAnswer(q, option)} className={`p-4 rounded-lg border-2 transition-all duration-200 text-left ${userAnswers[q.word] === option ? 'bg-blue-500 border-blue-500 text-white shadow-md' : 'bg-white border-gray-300 hover:border-blue-400'}`}>
                                {option}
                            </button>
                        ))}
                    </div>
                )}

                {q.type === 'fill-in-the-blank' && (
                    <input type="text" onChange={(e) => handleAnswer(q, e.target.value)} value={userAnswers[q.word] || ''} className="mt-2 p-3 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type the correct word..."/>
                )}

                {q.type === 'matching' && (
                    <div className="flex flex-col md:flex-row justify-between gap-8 mt-4">
                        <div className="flex-1 flex flex-col gap-2">
                            <h4 className="font-semibold text-center text-gray-600">Words</h4>
                            {q.words.map(word => {
                                const isSelected = selectedWord === word;
                                const isPaired = userAnswers[currentQuestionIndex] && userAnswers[currentQuestionIndex][word];
                                return (
                                    <button key={word} onClick={() => !isPaired && handleMatchingClick(word, 'word')} disabled={isPaired} className={`p-3 rounded-lg border-2 transition-all duration-200 ${isPaired ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : isSelected ? 'bg-blue-300 border-blue-400 ring-2 ring-blue-500' : 'bg-white hover:bg-blue-100'}`}>
                                        {word}
                                    </button>
                                );
                            })}
                        </div>
                         <div className="flex-1 flex flex-col gap-2">
                             <h4 className="font-semibold text-center text-gray-600">Definitions</h4>
                            {q.definitions.map(def => {
                                 const isSelected = selectedDef === def;
                                 const isPaired = userAnswers[currentQuestionIndex] && Object.values(userAnswers[currentQuestionIndex]).includes(def);
                                 return (
                                    <button key={def} onClick={() => !isPaired && handleMatchingClick(def, 'def')} disabled={isPaired} className={`p-3 rounded-lg border-2 transition-all duration-200 text-left ${isPaired ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : isSelected ? 'bg-green-300 border-green-400 ring-2 ring-green-500' : 'bg-white hover:bg-green-100'}`}>
                                        {def}
                                    </button>
                                 );
                            })}
                        </div>
                    </div>
                )}
                
                <div className="mt-8 flex justify-end">
                    <button onClick={nextQuestion} className="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300">
                        {currentQuestionIndex < questions.length - 1 ? 'Next' : 'Finish'}
                    </button>
                </div>
            </div>
        );
    };

    const renderResults = () => {
        const timeTaken = endTime && startTime ? ((endTime - startTime) / 1000).toFixed(2) : 0;
        const percentage = questions.length > 0 ? ((score / questions.length) * 100).toFixed(0) : 0;

        return (
            <div className="text-center">
                <h2 className="text-3xl font-bold mb-4 text-gray-800">Test Complete!</h2>
                <div className="bg-gray-100 p-6 rounded-lg shadow-inner mb-6">
                    <p className="text-2xl text-gray-700">Your Score: <span className="font-bold text-blue-600">{score.toFixed(1)} / {questions.length}</span></p>
                    <p className="text-4xl font-bold text-blue-600 mt-2">{percentage}%</p>
                    <p className="text-md text-gray-600 mt-4">Time Taken: {timeTaken} seconds</p>
                </div>
                 <div className="text-left mt-8 max-h-96 overflow-y-auto pr-2">
                    <h3 className="text-2xl font-semibold mb-4 border-b pb-2">Review Your Answers</h3>
                    {questions.map((q, index) => {
                        const key = q.type === 'matching' ? index : q.word;
                        const userAnswer = userAnswers[key];

                        if (q.type === 'matching') {
                           return (
                             <div key={index} className="mb-4 p-4 rounded-lg bg-white shadow">
                                <p className="font-semibold">{index + 1}. {q.question}</p>
                                <ul className="list-disc list-inside mt-2">
                                {q.words.map(word => {
                                    const userDef = userAnswer ? userAnswer[word] : "No answer";
                                    const correctDef = q.correctPairs[word];
                                    const isMatchCorrect = userDef === correctDef;
                                    return (
                                        <li key={word} className={isMatchCorrect ? 'text-green-700' : 'text-red-700'}>
                                            <strong>{word}:</strong> Your match "{userDef}" was {isMatchCorrect ? 'correct' : `incorrect. Correct was "${correctDef}"`}.
                                        </li>
                                    )
                                })}
                                </ul>
                             </div>
                           );
                        }
                        
                        let isCorrect = false;
                        let correctAnswerText = '';

                        if (q.type === 'multiple-choice') {
                            isCorrect = userAnswer === q.correctAnswer;
                            correctAnswerText = q.correctAnswer;
                        } else if (q.type === 'fill-in-the-blank') {
                            isCorrect = userAnswer && userAnswer.trim().toLowerCase() === q.correctAnswer.toLowerCase();
                            correctAnswerText = q.correctAnswer;
                        }

                        return (
                            <div key={key} className={`mb-4 p-4 rounded-lg shadow ${isCorrect ? 'bg-green-100 border-l-4 border-green-500' : 'bg-red-100 border-l-4 border-red-500'}`}>
                                <p className="font-semibold">{index + 1}. {q.question}</p>
                                <p className="mt-2">Your answer: <span className="font-medium">{userAnswer || 'No answer'}</span></p>
                                {!isCorrect && <p className="mt-1">Correct answer: <span className="font-medium">{correctAnswerText}</span></p>}
                            </div>
                        )
                    })}
                </div>
                <button onClick={startTest} className="mt-8 bg-blue-500 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 transform hover:scale-105">
                    Try Again
                </button>
            </div>
        );
    };

    return (
        <div className="bg-gray-50 min-h-screen font-sans flex items-center justify-center p-4">
            <main className="bg-white rounded-xl shadow-2xl p-6 md:p-8 max-w-4xl w-full">
                {view === 'intro' && renderIntro()}
                {view === 'test' && renderTest()}
                {view === 'results' && renderResults()}
            </main>
        </div>
    );
}
